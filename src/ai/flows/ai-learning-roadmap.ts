
// Use server directive is required for all Genkit flows.
'use server';

/**
 * @fileOverview AI-powered learning roadmap generator.
 *
 * This file defines a Genkit flow that generates a personalized learning roadmap based on the user's language, proficiency level, and goals.
 * The roadmap is structured into an introduction, a series of lessons, and a conclusion.
 *
 * @exports generatePersonalizedLearningRoadmap - The main function to generate the roadmap.
 * @exports GeneratePersonalizedLearningRoadmapInput - The input type for the function.
 * @exports GeneratePersonalizedLearningRoadmapOutput - The output type for the function (structured roadmap).
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';
import { interfaceLanguageCodes, targetLanguageNames, proficiencyLevels } from '@/lib/types';
import type { InterfaceLanguage as AppInterfaceLanguage, ProficiencyLevel as AppProficiencyLevel, TargetLanguage as AppTargetLanguage } from '@/lib/types';


const GeneratePersonalizedLearningRoadmapInputSchema = z.object({
  interfaceLanguage: z
    .enum(interfaceLanguageCodes)
    .describe('The ISO 639-1 code of the interface language for the user (e.g., en, ru, de). This language should be used for all instructions, titles, and descriptive text within the roadmap itself (introduction, lesson titles/descriptions, lesson topics, conclusion).'),
  targetLanguage: z.enum(targetLanguageNames).describe('The target language the user wants to study (e.g., German, English). The actual learning content and concepts in the roadmap (e.g., grammar rules, vocabulary themes) should be for this language.'),
  proficiencyLevel: z
    .enum(proficiencyLevels)
    .describe('The current/starting proficiency level of the user (e.g., A1-A2, B1-B2, C1-C2). The roadmap should cover A0-C2 regardless.'),
  personalGoal: z.string().describe('The personal goal of the user (e.g., Pass B2 TELC exam).'),
});

export type GeneratePersonalizedLearningRoadmapInput = z.infer<
  typeof GeneratePersonalizedLearningRoadmapInputSchema
>;

const LessonSchema = z.object({
  level: z.string().describe("CEFR level for this lesson/module (e.g., A1, A2, B1). Should be in the target language context if applicable (e.g. 'Niveau A1' for French target if interface is English, or '–£—Ä–æ–≤–µ–Ω—å A1' if interface is Russian). The text itself must be in the `interfaceLanguage`."),
  title: z.string().describe("Title of the lesson/module. MUST be in the specified `interfaceLanguage`."),
  description: z.string().describe("A brief overview of what this lesson/module covers. MUST be in the specified `interfaceLanguage`."),
  topics: z.array(z.string()).describe("Specific topics covered. Each topic string ITSELF MUST be in the specified `interfaceLanguage`. These topics should describe learning points related to the `targetLanguage` (e.g., for Russian interface and German target, a topic string should be '–ù–µ–º–µ—Ü–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç', NOT 'Das deutsche Alphabet')."),
  estimatedDuration: z.string().optional().describe("Estimated time to complete this lesson/module (e.g., '2 weeks', '10 hours', '2 –Ω–µ–¥–µ–ª–∏', '10 —á–∞—Å–æ–≤'). MUST be in the specified `interfaceLanguage`.")
});

const GeneratePersonalizedLearningRoadmapOutputSchema = z.object({
  introduction: z.string().describe("A general introduction to the learning plan. MUST be in the specified `interfaceLanguage`."),
  lessons: z.array(LessonSchema).describe("An array of lessons, structured sequentially from A0/A1 to C2. Ensure comprehensive coverage for the `targetLanguage` across all CEFR levels."),
  conclusion: z.string().optional().describe("A concluding remark or encouragement. MUST be in the specified `interfaceLanguage`.")
});

export type GeneratePersonalizedLearningRoadmapOutput = z.infer<
  typeof GeneratePersonalizedLearningRoadmapOutputSchema
>;

export async function generatePersonalizedLearningRoadmap(
  input: GeneratePersonalizedLearningRoadmapInput
): Promise<GeneratePersonalizedLearningRoadmapOutput> {
   const typedInput: GeneratePersonalizedLearningRoadmapInput = {
      ...input,
      interfaceLanguage: input.interfaceLanguage as AppInterfaceLanguage,
      targetLanguage: input.targetLanguage as AppTargetLanguage,
      proficiencyLevel: input.proficiencyLevel as AppProficiencyLevel,
  };
  return generatePersonalizedLearningRoadmapFlow(typedInput);
}

const generatePersonalizedLearningRoadmapPrompt = ai.definePrompt({
  name: 'generatePersonalizedLearningRoadmapPrompt',
  input: {schema: GeneratePersonalizedLearningRoadmapInputSchema},
  output: {schema: GeneratePersonalizedLearningRoadmapOutputSchema},
  prompt: `You are an AI language tutor specializing in creating personalized and structured learning roadmaps for language learners.

  Based on the user's interface language, target language, STARTING proficiency level, and personal goal, generate a COMPLETE and ADAPTIVE learning roadmap.

  The output MUST be a JSON object matching the provided schema.

  VERY IMPORTANT INSTRUCTIONS REGARDING LANGUAGE:
  1.  **Interface Language ({{{interfaceLanguage}}})**: ALL user-facing text within the roadmap structure ITSELF must be in this language. This includes:
      *   The 'introduction' field.
      *   The 'conclusion' field (if present).
      *   For EACH lesson in the 'lessons' array:
          *   The 'level' text (e.g., for Russian interface: '–£—Ä–æ–≤–µ–Ω—å A1', for English interface: 'Level A1').
          *   The 'title' of the lesson.
          *   The 'description' of the lesson.
          *   The 'estimatedDuration' text (e.g., '2 –Ω–µ–¥–µ–ª–∏', '2 weeks').
          *   CRITICALLY: EACH individual string within the 'topics' array. These strings describe learning points FOR the targetLanguage, but THE STRINGS THEMSELVES must be written in the {{{interfaceLanguage}}}. For example, if interfaceLanguage is 'ru' (Russian) and targetLanguage is 'German', a topic string for German alphabet should be '–ù–µ–º–µ—Ü–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç', NOT 'Das deutsche Alphabet'.

  2.  **Target Language ({{{targetLanguage}}})**: The actual linguistic concepts, grammar rules, vocabulary themes, etc., that the roadmap teaches should pertain to this language.

  CRITICAL FOR COMPREHENSIVENESS: The generated roadmap MUST be comprehensive. The 'lessons' array should cover all CEFR levels from A0/A1 (absolute beginner) to C2 (mastery) for the targetLanguage. The provided 'proficiencyLevel' indicates the user's STARTING point, but the plan must guide them through all subsequent levels up to C2. Structure the roadmap into clear lessons or modules. Aim for a reasonable number of lessons per CEFR level (e.g., 3-5 major modules per level).

  EXAMPLE (if interfaceLanguage='ru', targetLanguage='German'):
  - 'introduction' and 'conclusion' fields will be in Russian.
  - A lesson object might look like:
    {
      "level": "–£—Ä–æ–≤–µ–Ω—å A1", // In Russian
      "title": "–û—Å–Ω–æ–≤—ã –Ω–µ–º–µ—Ü–∫–æ–≥–æ: –ê–ª—Ñ–∞–≤–∏—Ç –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è", // In Russian
      "description": "–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∑–Ω–∞–∫–æ–º–∏—Ç —Å –Ω–µ–º–µ—Ü–∫–∏–º –∞–ª—Ñ–∞–≤–∏—Ç–æ–º, –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ–º –∏ –±–∞–∑–æ–≤—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞.", // In Russian
      "topics": ["–ù–µ–º–µ—Ü–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç", "–û—Å–Ω–æ–≤—ã –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è", "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –ø—Ä–æ—â–∞–Ω–∏—è", "–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–µ–±—è", "–ß–∏—Å–ª–∞ –æ—Ç 1 –¥–æ 10"], // CRITICAL: These topic strings are in Russian, describing German concepts.
      "estimatedDuration": "1 –Ω–µ–¥–µ–ª—è" // In Russian
    }

  SPECIFIC GUIDANCE FOR GERMAN LANGUAGE (if targetLanguage is 'German'):
  If the targetLanguage is 'German', pay close attention to the following detailed curriculum guideline for German language levels A1-C2. This is a strong reference for the depth, breadth, and type of topics expected. Adapt and structure these concepts (or similar ones covering the same grammatical points) into your lesson plan. Remember, while this guide details German grammar, the topics strings in your JSON output MUST be in the {{{interfaceLanguage}}}.

  --- BEGIN GERMAN LANGUAGE CURRICULUM GUIDELINE (A1-C2) ---

  üá©üá™ A1 (–ù–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å)
  –¶–µ–ª—å: –ø—Ä–æ—Å—Ç–æ–µ –æ–±—â–µ–Ω–∏–µ –Ω–∞ –±—ã—Ç–æ–≤—ã–µ —Ç–µ–º—ã, –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö —Ñ—Ä–∞–∑.

  üìö –õ–µ–∫—Å–∏–∫–∞:
  –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –ø—Ä–æ—â–∞–Ω–∏–µ
  –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–µ–±—è, —Å–µ–º—å–∏
  –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏, –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
  –ß–∏—Å–ª–∞, –≤–æ–∑—Ä–∞—Å—Ç, –≤—Ä–µ–º—è
  –ï–¥–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏
  –ü–æ–∫—É–ø–∫–∏, —Ü–µ–Ω—ã, –º–∞–≥–∞–∑–∏–Ω—ã
  –í –¥–æ–º–µ, –∫–≤–∞—Ä—Ç–∏—Ä–∞, –º–µ–±–µ–ª—å
  –ì–æ—Ä–æ–¥, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
  –ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
  –ü–æ–≥–æ–¥–∞, –≤—Ä–µ–º–µ–Ω–∞ –≥–æ–¥–∞
  –î–Ω–∏ –Ω–µ–¥–µ–ª–∏, –º–µ—Å—è—Ü—ã
  –•–æ–±–±–∏, —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è
  –ü—Ä–æ—Å—Ç—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É

  üî† –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:
  –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π/–Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∞—Ä—Ç–∏–∫–ª—å (der/die/das/ein/eine)
  –ú–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è (ich, du, er, sie, es ‚Ä¶)
  –°–ø—Ä—è–∂–µ–Ω–∏–µ –≥–ª–∞–≥–æ–ª–æ–≤ –≤ Pr√§sens (–∂–∏—Ç—å, –±—ã—Ç—å, –∏–º–µ—Ç—å, –¥–µ–ª–∞—Ç—å)
  –û—Å–Ω–æ–≤–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ (–≥–ª–∞–≥–æ–ª –Ω–∞ 2-–º –º–µ—Å—Ç–µ)
  –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ (wie, wo, was ‚Ä¶)
  –ü–æ–≤–µ–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∫–ª–æ–Ω–µ–Ω–∏–µ (du-—Ñ–æ—Ä–º—ã)
  Akkusativ/ Dativ –≤ –ø—Ä–æ—Å—Ç—ã—Ö —Ñ—Ä–∞–∑–∞—Ö
  –ú–æ–¥–∞–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã (m√ºssen, k√∂nnen, wollen ‚Ä¶)
  –ü—Ä–µ–¥–ª–æ–≥–∏ –º–µ—Å—Ç–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ (in, auf, an, um, am, im)
  –ü—Ä–æ—Å—Ç—ã–µ —Å–≤—è–∑–∫–∏: weil, aber, und

  üá©üá™ A2 (–ë–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)
  –¶–µ–ª—å: —É–≤–µ—Ä–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —è–∑—ã–∫–∞ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.

  üìö –õ–µ–∫—Å–∏–∫–∞:
  –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è, –±–∏–ª–µ—Ç—ã, –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã
  –ü—Ä–∞–∑–¥–Ω–∏–∫–∏, –ø–æ–¥–∞—Ä–∫–∏, –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
  –ó–¥–æ—Ä–æ–≤—å–µ, –ø–æ—Å–µ—â–µ–Ω–∏–µ –≤—Ä–∞—á–∞
  –ü–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–∞—è —Ä—É—Ç–∏–Ω–∞, —Ä–∞–±–æ—Ç–∞
  –û–¥–µ–∂–¥–∞, —Ü–≤–µ—Ç–∞, —Å—Ç–∏–ª—å
  –ü–∏—Å—å–º–æ, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞, –æ–±—ä—è–≤–ª–µ–Ω–∏—è
  –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –≤—Å—Ç—Ä–µ—á–∏, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏

  üî† –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:
  –ü—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è: Perfekt (Ich habe gearbeitet)
  Dativ/ Akkusativ —Å –∞—Ä—Ç–∏–∫–ª—è–º–∏ –∏ –ø—Ä–µ–¥–ª–æ–≥–∞–º–∏
  –ü—Ä–∏—Ç—è–∂–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è (mein, dein ‚Ä¶)
  –ì–ª–∞–≥–æ–ª—ã —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º (helfen + Dativ)
  –°–ª–æ–∂–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã
  –£–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ "es gibt", "man"
  –ß–∞—Å—Ç–∏—Ü—ã: doch, mal, ja, denn
  –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–¥–∞—Ç–æ—á–Ω—ã–µ: weil, dass, wenn
  –°—Ç–µ–ø–µ–Ω–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö

  üá©üá™ B1 (–ü–æ—Ä–æ–≥–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)
  –¶–µ–ª—å: —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–∞—Ö, –≤—ã—Ä–∞–∂–∞—Ç—å –º–Ω–µ–Ω–∏–µ.

  üìö –õ–µ–∫—Å–∏–∫–∞:
  –†–∞–±–æ—Ç–∞ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è, —Ä–µ–∑—é–º–µ, –∏–Ω—Ç–µ—Ä–≤—å—é
  –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —à–∫–æ–ª–∞, —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
  –û–±—â–µ—Å—Ç–≤–æ, –∫—É–ª—å—Ç—É—Ä–∞, –°–ú–ò
  –ü—Ä–∏—Ä–æ–¥–∞ –∏ —ç–∫–æ–ª–æ–≥–∏—è
  –ò—Å—Ç–æ—Ä–∏–∏, —Ä–∞—Å—Å–∫–∞–∑—ã, —Å–æ–±—ã—Ç–∏—è –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ
  –ß—É–≤—Å—Ç–≤–∞, –º–Ω–µ–Ω–∏—è, –∞—Ä–≥—É–º–µ–Ω—Ç—ã

  üî† –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:
  Plusquamperfekt (Ich hatte gemacht)
  Konjunktiv II (w√ºrde, k√∂nnte, h√§tte‚Ä¶)
  –ü—Ä–∏–¥–∞—Ç–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: obwohl, damit, als, w√§hrend
  –ü–∞—Å—Å–∏–≤ (Pr√§sens –∏ Pr√§teritum)
  –ù–∞—Ä–µ—á–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–æ—Ä—è–¥–∫–∞ (zuerst, danach, schlie√ülich)
  –ò–Ω—Ñ–∏–Ω–∏—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ mit "zu"
  Relativs√§tze (–∫–æ—Ç–æ—Ä—ã–π, –≥–¥–µ‚Ä¶)
  üí° –°–æ–≤–µ—Ç: B1 ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ TestDaF.

  üá©üá™ B2 (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å)
  –¶–µ–ª—å: —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–Ω–µ–Ω–∏–µ, –ø–æ–Ω–∏–º–∞—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–µ–º—ã.

  üìö –õ–µ–∫—Å–∏–∫–∞:
  –ü–æ–ª–∏—Ç–∏–∫–∞, –Ω–∞—É–∫–∞, —Ç–µ—Ö–Ω–∏–∫–∞
  –ú–∏–≥—Ä–∞—Ü–∏—è, –∫—É–ª—å—Ç—É—Ä–∞, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
  –≠–∫–æ–Ω–æ–º–∏–∫–∞, –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å—Ç–≤–æ
  –ò–Ω—Ç–µ—Ä–Ω–µ—Ç, —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏—è
  –û–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–Ω–µ–Ω–∏–µ, —Ä–µ–∫–ª–∞–º–∞, –°–ú–ò
  –≠—Å—Å–µ, –ø–∏—Å—å–º–∞, –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è

  üî† –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:
  Konjunktiv II Vergangenheit (h√§tte gemacht, w√§re gegangen)
  –°–ª–æ–∂–Ω—ã–π –ø–∞—Å—Å–∏–≤ + –º–æ–¥–∞–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã (k√∂nnte gemacht werden)
  –ù—é–∞–Ω—Å—ã —Å–æ—é–∑–æ–≤: dennoch, hingegen, somit
  Nominalisierung (Verlust ‚Üí der Verlust)
  –ü—Ä–∏–¥–∞—Ç–æ—á–Ω—ã–µ —Å Partizipien (das Auto, in der Garage stehend‚Ä¶)
  –°—Ç—Ä—É–∫—Ç—É—Ä—ã —Å "lassen", "werden", "sich lassen"

  üá©üá™ C1 (–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π)
  –¶–µ–ª—å: –≤–ª–∞–¥–µ–Ω–∏–µ —è–∑—ã–∫–æ–º –Ω–∞ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ, —É—á–∞—Å—Ç–∏–µ –≤ –¥–∏—Å–∫—É—Å—Å–∏—è—Ö, –Ω–∞–ø–∏—Å–∞–Ω–∏–µ —ç—Å—Å–µ.
  –£—Ä–æ–≤–µ–Ω—å —Å–¥–∞—á–∏ TestDaF –∏ Goethe-Zertifikat C1.

  üìö –õ–µ–∫—Å–∏–∫–∞:
  –ù–∞—É—á–Ω—ã–µ –∏ —Å–æ—Ü–∏–æ–∫—É–ª—å—Ç—É—Ä–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
  –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –≥—Ä–∞—Ñ–∏–∫–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
  –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Å—Å–µ, –≤–≤–æ–¥-–∞—Ä–≥—É–º–µ–Ω—Ç—ã-–∑–∞–∫–ª—é—á–µ–Ω–∏–µ
  –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞ (—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, —Ä–∞–±–æ—Ç–∞)

  üî† –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:
  –í—Å–µ –≤—Ä–µ–º–µ–Ω–∞ (Perfekt, Plusquamperfekt, Futur I/II)
  –í—Å–µ —Ç–∏–ø—ã –ø–∞—Å—Å–∏–≤–∞ –∏ Konjunktiv I/II
  –ö–æ—Å–≤–µ–Ω–Ω–∞—è —Ä–µ—á—å (Er sagte, er habe ‚Ä¶)
  –°–ª–æ–∂–Ω—ã–µ –∏–Ω—Ñ–∏–Ω–∏—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–∏—á–∞—Å—Ç–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
  –î–ª–∏–Ω–Ω—ã–µ –ø—Ä–∏–¥–∞—Ç–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
  –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞: —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π / –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π / –ø—É–±–ª–∏—Ü–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å
  –£–ø—Ä–æ—â—ë–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã: "es sei denn", "geschweige denn", "sowohl ‚Ä¶ als auch ‚Ä¶"

  üá©üá™ C2 (–ù–æ—Å–∏—Ç–µ–ª—å—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å)
  –¶–µ–ª—å: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏–ª–∏ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ, –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤.

  üìö –õ–µ–∫—Å–∏–∫–∞:
  –§–∏–ª–æ—Å–æ—Ñ–∏—è, –ø—Ä–∞–≤–æ, —ç–∫–æ–Ω–æ–º–∏–∫–∞
  –Ø–∑—ã–∫–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑, –º–µ—Ç–∞—Ñ–æ—Ä—ã, —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞
  –ò–¥–∏–æ–º—ã, –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –æ—Ç—Å—ã–ª–∫–∏
  –†–∏—Ç–æ—Ä–∏–∫–∞, —Ä–µ—á–µ–≤—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏

  üî† –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞:
  –í—Å–µ –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω–æ–µ + –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
  –°–∂–∞—Ç–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–∑–∞–º–µ–Ω—ã —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π)
  –†–µ–¥–∫–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —Ñ–æ—Ä–º—ã –≥–ª–∞–≥–æ–ª–æ–≤, –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏–π
  –£—Å—Ç–æ–π—á–∏–≤—ã–µ –æ–±–æ—Ä–æ—Ç—ã, –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
  –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

  üìë –î–ª—è —ç–∫–∑–∞–º–µ–Ω–æ–≤:
  üéì Goethe C1/C2:
  –¢–µ—Å—Ç–∏—Ä—É–µ—Ç: —á—Ç–µ–Ω–∏–µ, –∞—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–∏—Å—å–º–æ, –≥–æ–≤–æ—Ä–µ–Ω–∏–µ
  –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å—Ç–∏–ª—å

  üéì TestDaF (—É—Ä–æ–≤–µ–Ω—å –ø—Ä–∏–º–µ—Ä–Ω–æ B2‚ÄìC1):
  TestDaF-4 = —É—Ä–æ–≤–µ–Ω—å C1
  –¢–µ–º—ã: —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç, –æ–±—É—á–µ–Ω–∏–µ, –Ω–∞—É–∫–∞, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, –æ–±—â–µ—Å—Ç–≤–æ
  –¢–µ—Å—Ç–∏—Ä—É–µ—Ç:
  –ß—Ç–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
  –ü–∏—Å—å–º–æ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–≥–æ —ç—Å—Å–µ
  –£—Å—Ç–Ω—É—é —Ä–µ—á—å (–æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è)
  –ê—É–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö –ª–µ–∫—Ü–∏–π

  --- END GERMAN LANGUAGE CURRICULUM GUIDELINE ---

  User's chosen interface language (for ALL roadmap text like titles, descriptions, level text, AND EACH TOPIC STRING): {{{interfaceLanguage}}}
  User's target language (for the concepts the learning content refers to): {{{targetLanguage}}}
  User's STARTING proficiency level (for context, but plan must be A0-C2): {{{proficiencyLevel}}}
  User's personal goal: {{{personalGoal}}}

  Generate the structured learning roadmap now according to ALL the instructions above.
  `,
});

const generatePersonalizedLearningRoadmapFlow = ai.defineFlow(
  {
    name: 'generatePersonalizedLearningRoadmapFlow',
    inputSchema: GeneratePersonalizedLearningRoadmapInputSchema,
    outputSchema: GeneratePersonalizedLearningRoadmapOutputSchema,
  },
  async (input: GeneratePersonalizedLearningRoadmapInput) => {
    const {output} = await generatePersonalizedLearningRoadmapPrompt(input);
    // Ensure output is not null or undefined before returning
    if (!output) {
        throw new Error("AI failed to generate a learning roadmap. Output was null.");
    }
    return output;
  }
);

